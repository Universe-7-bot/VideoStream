<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Upload Video</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style1.css">
    <link rel="stylesheet" type="text/css" href="/css/style2.css">
    <style>
        .progress {
            width: 95%;
            height: 0.9rem;
            background-color: rgb(240, 205, 205);
        }

        .upload-video-progress-bar-text {
            margin: 0.2rem 0 0 0;
            font-size: 13px;
            color: rgb(127, 123, 123);
        }

        .progress-bar-animated-custom {
            animation: progress-animation 4s forwards;
        }

        @keyframes progress-animation {
            0% {
                width: 0;
            }

            30% {
                width: 30%;
                animation-timing-function: ease-in;
            }

            70% {
                width: 70%;
                animation-timing-function: ease-in;
            }

            100% {
                width: 100%;
            }
        }

        .progress-bar-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #1a1a1a;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="upload-main-div">
        <%- include("components/header.ejs") %>
            <div class="sidenav-content d-flex flex-row">
                <%- include("components/side-navbar.ejs") %>
                    <div class="content-wrapper" id="content-wrapper">
                        <div class="row upload-row">
                            <div class="upload-header">
                                <p class="upload-header-title">Upload Details</p>
                            </div>
                            <div class="upload-video-div d-flex flex-row">
                                <div class="upload-show-video" id="video-wrapper">
                                    <div class="upload-show-video-before" id="upload-show-video-before">
                                        <img class="preview-video-icon" src="/images/preview-video.svg"
                                            alt="video-icon">
                                        <p class="upload-show-video-text">Your video will show here</p>
                                    </div>
                                </div>
                                <div class="upload-dragdrop" id="drag-drop-zone">
                                    <img class="upload-icon" src="/images/upload.svg" alt="upload-icon">
                                    <p class="drag-drop-text">Drag and drop video file here or</p>
                                    <button id="upload-button">Browse Video</button>
                                    <form>
                                        <input type="file" name="video" id="file-input" accept="video/*" multiple>
                                    </form>
                                </div>
                                <div class="upload-video-progress" id="upload-video-progress">
                                    <div class="progress video-progress" role="progressbar" aria-label="Example with label"
                                        aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                        <div class="progress-bar video-progress-bar progress-bar-striped progress-bar-animated progress-bar-animated-custom bg-danger"
                                            style="width: 0%">
                                            <span class="progress-bar-percentage">0%</span>
                                        </div>
                                    </div>
                                    <p class="upload-video-progress-bar-text">your video is uploading...</p>
                                </div>
                            </div>
                            <div class="upload-image-div d-flex flex-row">
                                <div class="upload-show-image" id="image-wrapper">
                                    <div class="upload-show-image-before" id="upload-show-image-before">
                                        <img class="preview-image-icon" src="/images/preview-image.svg"
                                            alt="image-icon">
                                        <p class="upload-show-image-text">Your thumbnail will show here</p>
                                    </div>
                                </div>
                                <div class="upload-dragdrop-img" id="drag-drop-zone-img">
                                    <img class="upload-icon" src="/images/upload.svg" alt="upload-icon">
                                    <p class="drag-drop-text">Drag and drop image file here or</p>
                                    <button id="upload-button-img">Browse Image</button>
                                    <form>
                                        <input type="file" name="thumbnail" id="file-input-img" accept="image/*"
                                            multiple>
                                    </form>
                                </div>
                                <div class="upload-image-progress" id="upload-image-progress">
                                    <div class="progress image-progress" role="progressbar" aria-label="Example with label"
                                        aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                        <div class="progress-bar image-progress-bar progress-bar-striped progress-bar-animated progress-bar-animated-custom bg-danger"
                                            style="width: 0%">
                                            <span class="progress-bar-percentage">0%</span>
                                        </div>
                                    </div>
                                    <p class="upload-video-progress-bar-text">your thumbnail is uploading...</p>
                                </div>
                            </div>
                            <div class="upload-separator">
                                <hr>
                            </div>
                            <div class="upload-video-details-wrapper">
                                <form>
                                    <div class="upload-video-title">
                                        <p class="upload-video-common-text">Video Title</p>
                                        <input type="text" name="title" class="upload-input" id="title"
                                            placeholder="e.g. my first video">
                                    </div>
                                    <div class="upload-video-description">
                                        <p class="upload-video-common-text">Video Description</p>
                                        <textarea class="upload-input" id="description" rows="4"
                                            placeholder="Description"></textarea>
                                    </div>
                                    <div class="upload-video-tags">
                                        <p class="upload-video-common-text">Video Tags</p>
                                        <input type="text" name="tags" class="upload-input" id="tags"
                                            placeholder="e.g. #gaming, #viral">
                                    </div>
                                    <div class="upload-video-category">
                                        <p class="upload-video-common-text">Video Category</p>
                                        <select class="form-select" id="category" aria-label="Default select example">
                                            <option value="Technology">Technology</option>
                                            <option value="Gaming">Gaming</option>
                                            <option value="Education">Education</option>
                                            <option value="Entertainment">Entertainment</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="upload-submit-btn-div">
                                <button onclick="upload()" class="upload-submit-btn">Submit</button>
                            </div>
                        </div>
                    </div>
            </div>
    </div>
    <%- include("components/footer.ejs") %>
        <script>
            const dragDropZone = document.getElementById("drag-drop-zone");
            const dragDropText = document.querySelector(".drag-drop-text");
            const uploadButton = document.getElementById("upload-button");
            const fileInput = document.getElementById("file-input");
            const videoWrapper = document.getElementById("video-wrapper");
            const videoPreviewBefore = document.getElementById("upload-show-video-before");

            const dragDropZoneImg = document.getElementById("drag-drop-zone-img");
            const uploadButtonImg = document.getElementById("upload-button-img");
            const fileInputImg = document.getElementById("file-input-img");
            const imageWrapper = document.getElementById("image-wrapper");
            const imagePreviewBefore = document.getElementById("upload-show-image-before");

            let video, thumbnail;

            dragDropZone.addEventListener("dragover", (event) => {
                event.preventDefault();
                dragDropZone.classList.add("drag-over");
            });

            dragDropZone.addEventListener("dragleave", () => {
                dragDropZone.classList.remove("drag-over");
            });

            dragDropZone.addEventListener("drop", (event) => {
                event.preventDefault();
                dragDropZone.classList.remove("drag-over");
                const files = event.dataTransfer.files;
                handleFiles(files);
            });

            fileInput.addEventListener("change", (event) => {
                const files = event.target.files;
                handleFiles(files);
            });

            uploadButton.addEventListener("click", () => {
                fileInput.click();
            });

            dragDropZoneImg.addEventListener("dragover", (event) => {
                event.preventDefault();
                dragDropZoneImg.classList.add("drag-over");
            });

            dragDropZoneImg.addEventListener("dragleave", () => {
                dragDropZoneImg.classList.remove("drag-over");
            });

            dragDropZoneImg.addEventListener("drop", (event) => {
                event.preventDefault();
                dragDropZoneImg.classList.remove("drag-over");
                const imgFiles = event.dataTransfer.files;
                handleImages(imgFiles);
            });

            fileInputImg.addEventListener("change", (event) => {
                const imgFiles = event.target.files;
                handleImages(imgFiles);
            });

            uploadButtonImg.addEventListener("click", () => {
                fileInputImg.click();
            });

            async function handleFiles(files) {
                const videoProgress = document.getElementById("upload-video-progress");
                const progressBar = document.querySelector(".video-progress-bar");
                var percentage = 0;
                var interval = 40;
                var uploaded = false;
                // videoWrapper.style.display = "block";
                // videoPreviewBefore.style.display = "none";

                const existingVideoElement = document.querySelector(".uploaded-video");
                if (existingVideoElement) {
                    existingVideoElement.remove();
                    videoPreviewBefore.style.display = "flex";
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileType = file.type.split("/")[0];
                    if (fileType === "video") {
                        uploaded = true;
                        video = file;
                        const videoElement = document.createElement("video");
                        videoElement.src = URL.createObjectURL(file);
                        videoElement.controls = true;
                        // videoElement.autoplay = true;
                        videoElement.classList.add("uploaded-video");
                        videoWrapper.appendChild(videoElement);
                        break;
                    }
                }

                if (uploaded) {
                    dragDropZone.style.display = "none";
                    videoProgress.style.display = "flex";
                    var uploadedVideo = document.querySelector(".uploaded-video");

                    var progressAnimation = await setInterval(function () {
                        percentage += 1;
                        progressBar.style.width = percentage + "%";
                        progressBar.textContent = percentage + "%";
                        if (percentage >= 100) {
                            clearInterval(progressAnimation);
                            videoPreviewBefore.style.display = "none";
                            videoProgress.style.display = "none";
                            dragDropZone.style.display = "flex";
                            uploadedVideo.style.display = "block"
                            // uploadedVideo.setAttribute("autoplay", "true");
                        }
                    }, interval);
                }
            }

            async function handleImages(files) {
                const imageProgress = document.getElementById("upload-image-progress");
                const progressBar = document.querySelector(".image-progress-bar");
                var percentage = 0;
                var interval = 40;
                var uploaded = false;
                // imageWrapper.style.display = "block";

                const existingImageElement = document.querySelector(".uploaded-image");
                if (existingImageElement) {
                    existingImageElement.remove();
                    imagePreviewBefore.style.display = "flex";
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileType = file.type.split("/")[0];
                    if (fileType === "image") {
                        uploaded = true;
                        thumbnail = file;
                        const imageElement = document.createElement("img");
                        imageElement.src = URL.createObjectURL(file);
                        imageElement.classList.add("uploaded-image");
                        imageWrapper.appendChild(imageElement);
                        break;
                    }
                }

                 if (uploaded) {
                    dragDropZoneImg.style.display = "none";
                    imageProgress.style.display = "flex";
                    var uploadedImage = document.querySelector(".uploaded-image");

                    var progressAnimation = await setInterval(function () {
                        percentage += 1;
                        progressBar.style.width = percentage + "%";
                        progressBar.textContent = percentage + "%";
                        if (percentage >= 100) {
                            clearInterval(progressAnimation);
                            imagePreviewBefore.style.display = "none";
                            imageProgress.style.display = "none";
                            dragDropZoneImg.style.display = "flex";
                            uploadedImage.style.display = "block"
                            // uploadedImage.setAttribute("autoplay", "true");
                        }
                    }, interval);
                }
            }

            const upload = () => {
                if (!video)
                    video = document.getElementById("file-input").files[0];
                if (!thumbnail)
                    thumbnail = document.getElementById("file-input-img").files[0];

                const title = document.getElementById("title").value;
                const description = document.getElementById("description").value;
                const tags = document.getElementById("tags").value;
                const category = document.getElementById("category").value;

                const formData = new FormData();
                formData.append("video", video),
                    formData.append("thumbnail", thumbnail),
                    formData.append("title", title),
                    formData.append("description", description),
                    formData.append("tags", tags),
                    formData.append("category", category),
                    // console.log(video, thumbnail, title, description, tags, category);

                    fetch("http://localhost:3000/upload-video", {
                        method: "POST", body: formData
                    }).then((res) => {
                        return res.json();
                    }).then((f_res) => {
                        if (f_res.code == 500) {
                            Toastify({
                                text: f_res.msg,
                                duration: 2000,
                                newWindow: true,
                                close: true,
                                gravity: "top",
                                position: "right",
                                stopOnFocus: true,
                                avatar: "images/error-icon.svg",
                                style: {
                                    background: "#000000",
                                },
                                onClick: function () { } // Callback after click
                            }).showToast();
                        }
                        else if (f_res.code == 400) {
                            Toastify({
                                text: f_res.msg,
                                duration: 2000,
                                newWindow: true,
                                close: true,
                                gravity: "top",
                                position: "right",
                                stopOnFocus: true,
                                avatar: "images/success-icon.svg",
                                style: {
                                    background: "#000000",
                                },
                                onClick: function () { } // Callback after click
                            }).showToast();

                            setTimeout(() => {
                                window.location.href = "/";
                            }, 1500)
                        }
                    })
            };
        </script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
            crossorigin="anonymous"></script>
</body>

</html>